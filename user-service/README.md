# User Service Guide

## Setting-up

> :notebook: If you are familiar to MongoDB and wish to use a local instance, please feel free to do so. This guide utilizes MongoDB Cloud Services.

1. Set up a MongoDB Shared Cluster by following the steps in this [Guide](./MongoDBSetup.md).

2. After setting up, go to the Database Deployment Page. You would see a list of the Databases you have set up. Select `Connect` on the cluster you just created earlier on for User Service.

   ![alt text](./GuideAssets/ConnectCluster.png)

3. Select the `Drivers` option, as we have to link to a Node.js App (User Service).

   ![alt text](./GuideAssets/DriverSelection.png)

4. Select `Node.js` in the `Driver` pull-down menu, and copy the connection string.

   Notice, you may see `<password>` in this connection string. We will be replacing this with the admin account password that we created earlier on when setting up the Shared Cluster.

   ![alt text](./GuideAssets/ConnectionString.png)

5. In the `user-service` directory, create a copy of the `.env.sample` file and name it `.env`.

6. Update the `DB_CLOUD_URI` of the `.env` file, and paste the string we copied earlier in step 4. Also remember to replace the `<password>` placeholder with the actual password.

## Running User Service

1. Open Command Line/Terminal and navigate into the `user-service` directory.

2. Run the command: `npm install`. This will install all the necessary dependencies.

3. Run the command `npm start` to start the User Service in production mode, or use `npm run dev` for development mode, which includes features like automatic server restart when you make code changes.

4. Using applications like Postman, you can interact with the User Service on port 3001. If you wish to change this, please update the `.env` file.

## User Service API Guide

### API Endpoints Summary

The User Service provides comprehensive user management and authentication functionality through the following endpoints:

#### User Management
- **POST /users** - Create a new user (registration)
- **GET /users** - Get all users (admin only)
- **GET /users/{userId}** - Get a specific user's data
- **PATCH /users/{userId}** - Update user information
- **PATCH /users/{userId}/privilege** - Update user admin privilege (admin only)
- **PATCH /users/{userId}/password** - Update user password (authenticated)
- **PATCH /users/{userId}/username** - Update username (authenticated)
- **DELETE /users/{userId}** - Delete a user

#### Authentication
- **POST /auth/login** - User login with email and password
- **GET /auth/verify-token** - Verify JWT access token validity

#### Password Reset
- **POST /auth/password/request-reset** - Request password reset email
- **GET /auth/password/validate-token** - Validate password reset token
- **POST /auth/password/confirm-reset** - Confirm password reset with new password

#### Email Verification & Change
- **GET /verification/verify** - Verify email address with token
- **POST /verification/resend** - Resend verification email
- **POST /verification/request-email-change-code** - Request 6-digit code for email change
- **POST /verification/verify-email-change-code** - Verify 6-digit email change code
- **POST /verification/change-email** - Complete email change process

---

### Create User

- This endpoint allows adding a new user to the database (i.e., user registration).

- HTTP Method: `POST`

- Endpoint: http://localhost:3001/users

- Body
  - Required: `username` (string), `email` (string), `password` (string)

    ```json
    {
      "username": "SampleUserName",
      "email": "sample@gmail.com",
      "password": "SecurePassword"
    }
    ```

- Responses:

  | Response Code               | Explanation                                           |
  | --------------------------- | ----------------------------------------------------- |
  | 201 (Created)               | User created successfully, created user data returned |
  | 400 (Bad Request)           | Missing fields                                        |
  | 409 (Conflict)              | Duplicate username or email encountered               |
  | 500 (Internal Server Error) | Database or server error                              |

### Get User

- This endpoint allows retrieval of a single user's data from the database using the user's ID.

  > :bulb: The user ID refers to the MongoDB Object ID, a unique identifier automatically generated by MongoDB for each document in a collection.

- HTTP Method: `GET`

- Endpoint: http://localhost:3001/users/{userId}

- Parameters
  - Required: `userId` path parameter
  - Example: `http://localhost:3001/users/60c72b2f9b1d4c3a2e5f8b4c`

- <a name="auth-header">Headers</a>
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`
  - Explanation: This endpoint requires the client to include a JWT (JSON Web Token) in the HTTP request header for authentication and authorization. This token is generated during the authentication process (i.e., login) and contains information about the user's identity. The server verifies this token to ensure that the client is authorized to access the data.
  - Auth Rules:
    - Admin users: Can retrieve any user's data. The server verifies the user associated with the JWT token is an admin user and allows access to the requested user's data.
    - Non-admin users: Can only retrieve their own data. The server checks if the user ID in the request URL matches the ID of the user associated with the JWT token. If it matches, the server returns the user's own data.

- Responses:

  | Response Code               | Explanation                                              |
  | --------------------------- | -------------------------------------------------------- |
  | 200 (OK)                    | Success, user data returned                              |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT         |
  | 403 (Forbidden)             | Access denied for non-admin users accessing others' data |
  | 404 (Not Found)             | User with the specified ID not found                     |
  | 500 (Internal Server Error) | Database or server error                                 |

### Get All Users

- This endpoint allows retrieval of all users' data from the database.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/users
- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`
  - Auth Rules:
    - Admin users: Can retrieve all users' data. The server verifies the user associated with the JWT token is an admin user and allows access to all users' data.
    - Non-admin users: Not allowed access.

- Responses:

  | Response Code               | Explanation                                      |
  | --------------------------- | ------------------------------------------------ |
  | 200 (OK)                    | Success, all user data returned                  |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT |
  | 403 (Forbidden)             | Access denied for non-admin users                |
  | 500 (Internal Server Error) | Database or server error                         |

### Update User

- This endpoint allows updating a user and their related data in the database using the user's ID.

- HTTP Method: `PATCH`

- Endpoint: http://localhost:3001/users/{userId}

- Parameters
  - Required: `userId` path parameter

- Body
  - At least one of the following fields is required: `username` (string), `email` (string), `password` (string)

    ```json
    {
      "username": "SampleUserName",
      "email": "sample@gmail.com",
      "password": "SecurePassword"
    }
    ```

- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`
  - Auth Rules:
    - Admin users: Can update any user's data. The server verifies the user associated with the JWT token is an admin user and allows the update of requested user's data.
    - Non-admin users: Can only update their own data. The server checks if the user ID in the request URL matches the ID of the user associated with the JWT token. If it matches, the server updates the user's own data.

- Responses:

  | Response Code               | Explanation                                             |
  | --------------------------- | ------------------------------------------------------- |
  | 200 (OK)                    | User updated successfully, updated user data returned   |
  | 400 (Bad Request)           | Missing fields                                          |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT        |
  | 403 (Forbidden)             | Access denied for non-admin users updating others' data |
  | 404 (Not Found)             | User with the specified ID not found                    |
  | 409 (Conflict)              | Duplicate username or email encountered                 |
  | 500 (Internal Server Error) | Database or server error                                |

### Update User Privilege

- This endpoint allows updating a userâ€™s privilege, i.e., promoting or demoting them from admin status.

- HTTP Method: `PATCH`

- Endpoint: http://localhost:3001/users/{userId}

- Parameters
  - Required: `userId` path parameter

- Body
  - Required: `isAdmin` (boolean)

    ```json
    {
      "isAdmin": true
    }
    ```

- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`
  - Auth Rules:
    - Admin users: Can update any user's privilege. The server verifies the user associated with the JWT token is an admin user and allows the privilege update.
    - Non-admin users: Not allowed access.

> :bulb: You may need to manually assign admin status to the first user by directly editing the database document before using this endpoint.

- Responses:

  | Response Code               | Explanation                                                     |
  | --------------------------- | --------------------------------------------------------------- |
  | 200 (OK)                    | User privilege updated successfully, updated user data returned |
  | 400 (Bad Request)           | Missing fields                                                  |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT                |
  | 403 (Forbidden)             | Access denied for non-admin users                               |
  | 404 (Not Found)             | User with the specified ID not found                            |
  | 500 (Internal Server Error) | Database or server error                                        |

### Delete User

- This endpoint allows deletion of a user and their related data from the database using the user's ID.
- HTTP Method: `DELETE`
- Endpoint: http://localhost:3001/users/{userId}
- Parameters
  - Required: `userId` path parameter

- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`

  - Auth Rules:
    - Admin users: Can delete any user's data. The server verifies the user associated with the JWT token is an admin user and allows the deletion of requested user's data.

    - Non-admin users: Can only delete their own data. The server checks if the user ID in the request URL matches the ID of the user associated with the JWT token. If it matches, the server deletes the user's own data.

- Responses:

  | Response Code               | Explanation                                             |
  | --------------------------- | ------------------------------------------------------- |
  | 200 (OK)                    | User deleted successfully                               |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT        |
  | 403 (Forbidden)             | Access denied for non-admin users deleting others' data |
  | 404 (Not Found)             | User with the specified ID not found                    |
  | 500 (Internal Server Error) | Database or server error                                |

### Login

- This endpoint allows a user to authenticate with an email and password and returns a JWT access token. The token is valid for 1 day and can be used subsequently to access protected resources. For example usage, refer to the [Authorization header section in the Get User endpoint](#auth-header).
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/login
- Body
  - Required: `email` (string), `password` (string)

    ```json
    {
      "email": "sample@gmail.com",
      "password": "SecurePassword"
    }
    ```

- Responses:

  | Response Code               | Explanation                                        |
  | --------------------------- | -------------------------------------------------- |
  | 200 (OK)                    | Login successful, JWT token and user data returned |
  | 400 (Bad Request)           | Missing fields                                     |
  | 401 (Unauthorized)          | Incorrect email or password                        |
  | 500 (Internal Server Error) | Database or server error                           |

### Verify Token

- This endpoint allows one to verify a JWT access token to authenticate and retrieve the user's data associated with the token.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/auth/verify-token
- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`

- Responses:

  | Response Code               | Explanation                                        |
  | --------------------------- | -------------------------------------------------- |
  | 200 (OK)                    | Token verified, authenticated user's data returned |
  | 401 (Unauthorized)          | Missing/invalid/expired JWT                        |
  | 500 (Internal Server Error) | Database or server error                           |

### Request Password Reset

- This endpoint initiates the password reset process by sending a reset email to the user.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/password/request-reset
- Body
  - Required: `email` (string)

    ```json
    {
      "email": "sample@gmail.com"
    }
    ```

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Password reset email sent successfully   |
  | 400 (Bad Request)           | Missing email field                      |
  | 404 (Not Found)             | User with specified email not found      |
  | 500 (Internal Server Error) | Database or server error                 |

### Validate Password Reset Token

- This endpoint validates a password reset token without changing the password.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/auth/password/validate-token
- Query Parameters
  - Required: `username` (string), `email` (string), `token` (string)
  - Example: `http://localhost:3001/auth/password/validate-token?username=SampleUserName&email=sample@gmail.com&token=abc123`

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Token is valid                           |
  | 400 (Bad Request)           | Missing parameters                       |
  | 401 (Unauthorized)          | Invalid or expired token                 |
  | 404 (Not Found)             | User not found                           |
  | 500 (Internal Server Error) | Database or server error                 |

### Confirm Password Reset

- This endpoint confirms the password reset using the token and sets a new password.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/auth/password/confirm-reset
- Query Parameters
  - Required: `username` (string), `email` (string), `token` (string)
- Body
  - Required: `newPassword` (string)

    ```json
    {
      "newPassword": "NewSecurePassword123!"
    }
    ```

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Password reset successful                |
  | 400 (Bad Request)           | Missing parameters or new password       |
  | 401 (Unauthorized)          | Invalid or expired token                 |
  | 404 (Not Found)             | User not found                           |
  | 500 (Internal Server Error) | Database or server error                 |

### Update User Password

- This endpoint allows a user to update their password while authenticated.
- HTTP Method: `PATCH`
- Endpoint: http://localhost:3001/users/{userId}/password
- Parameters
  - Required: `userId` path parameter
- Body
  - Required: `currentPassword` (string), `newPassword` (string)

    ```json
    {
      "currentPassword": "OldPassword123!",
      "newPassword": "NewSecurePassword123!"
    }
    ```

- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`
  - Auth Rules:
    - Admin users: Can update any user's password
    - Non-admin users: Can only update their own password

- Responses:

  | Response Code               | Explanation                                             |
  | --------------------------- | ------------------------------------------------------- |
  | 200 (OK)                    | Password updated successfully                           |
  | 400 (Bad Request)           | Missing fields or incorrect current password            |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT        |
  | 403 (Forbidden)             | Access denied for non-admin users updating others' data |
  | 404 (Not Found)             | User with the specified ID not found                    |
  | 500 (Internal Server Error) | Database or server error                                |

### Update Username

- This endpoint allows a user to update their username while authenticated.
- HTTP Method: `PATCH`
- Endpoint: http://localhost:3001/users/{userId}/username
- Parameters
  - Required: `userId` path parameter
- Body
  - Required: `username` (string)

    ```json
    {
      "username": "NewUsername"
    }
    ```

- Headers
  - Required: `Authorization: Bearer <JWT_ACCESS_TOKEN>`
  - Auth Rules:
    - Admin users: Can update any user's username
    - Non-admin users: Can only update their own username

- Responses:

  | Response Code               | Explanation                                             |
  | --------------------------- | ------------------------------------------------------- |
  | 200 (OK)                    | Username updated successfully                           |
  | 400 (Bad Request)           | Missing username field                                  |
  | 401 (Unauthorized)          | Access denied due to missing/invalid/expired JWT        |
  | 403 (Forbidden)             | Access denied for non-admin users updating others' data |
  | 404 (Not Found)             | User with the specified ID not found                    |
  | 409 (Conflict)              | Username already taken                                  |
  | 500 (Internal Server Error) | Database or server error                                |

### Verify Email

- This endpoint verifies a user's email address using a verification token sent via email.
- HTTP Method: `GET`
- Endpoint: http://localhost:3001/verification/verify
- Query Parameters
  - Required: `username` (string), `email` (string), `token` (string)
  - Optional: `purpose` (string, defaults to 'signup')
  - Example: `http://localhost:3001/verification/verify?username=SampleUserName&email=sample@gmail.com&token=abc123&purpose=signup`

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Email verified successfully              |
  | 400 (Bad Request)           | Missing parameters                       |
  | 401 (Unauthorized)          | Invalid or expired token                 |
  | 404 (Not Found)             | User not found                           |
  | 500 (Internal Server Error) | Database or server error                 |

### Resend Verification Email

- This endpoint resends the verification email to the user.
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/verification/resend
- Query Parameters
  - Required: `username` (string), `email` (string)
  - Optional: `purpose` (string, defaults to 'signup')
  - Example: `http://localhost:3001/verification/resend?username=SampleUserName&email=sample@gmail.com&purpose=signup`

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Verification email sent successfully     |
  | 400 (Bad Request)           | Missing parameters                       |
  | 404 (Not Found)             | User not found                           |
  | 500 (Internal Server Error) | Database or server error                 |

### Request Email Change Code

- This endpoint requests a 6-digit verification code to initiate the email change process (Step 1).
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/verification/request-email-change-code
- Body
  - Required: `userId` (string)

    ```json
    {
      "userId": "60c72b2f9b1d4c3a2e5f8b4c"
    }
    ```

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Verification code sent to current email  |
  | 400 (Bad Request)           | Missing userId field                     |
  | 404 (Not Found)             | User not found                           |
  | 500 (Internal Server Error) | Database or server error                 |

### Verify Email Change Code

- This endpoint verifies the 6-digit code without changing the email (Step 1.5).
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/verification/verify-email-change-code
- Body
  - Required: `userId` (string), `code` (string)

    ```json
    {
      "userId": "60c72b2f9b1d4c3a2e5f8b4c",
      "code": "123456"
    }
    ```

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Code verified successfully               |
  | 400 (Bad Request)           | Missing parameters or invalid code       |
  | 401 (Unauthorized)          | Code expired or incorrect                |
  | 404 (Not Found)             | User not found                           |
  | 500 (Internal Server Error) | Database or server error                 |

### Change Email

- This endpoint completes the email change process after validating the 6-digit code (Step 2).
- HTTP Method: `POST`
- Endpoint: http://localhost:3001/verification/change-email
- Body
  - Required: `userId` (string), `username` (string), `oldEmail` (string), `newEmail` (string), `code` (string)

    ```json
    {
      "userId": "60c72b2f9b1d4c3a2e5f8b4c",
      "username": "SampleUserName",
      "oldEmail": "old@gmail.com",
      "newEmail": "new@gmail.com",
      "code": "123456"
    }
    ```

- Responses:

  | Response Code               | Explanation                              |
  | --------------------------- | ---------------------------------------- |
  | 200 (OK)                    | Verification link sent to new email      |
  | 400 (Bad Request)           | Missing parameters or invalid code       |
  | 401 (Unauthorized)          | Code expired or incorrect                |
  | 404 (Not Found)             | User not found                           |
  | 409 (Conflict)              | New email already in use                 |
  | 500 (Internal Server Error) | Database or server error                 |
